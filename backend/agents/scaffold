åŸºäºä½ æä¾›çš„ NewsRetrievalAgent (retriv.py) å’Œ AccountantAgent ä»¥åŠ MCP æœåŠ¡æ¶æ„ (start_mcp.py)ï¼Œæˆ‘ä¸ºä½ æ¢³ç†äº†ä¸€ä»½ Project NewsieAI é€šç”¨ Agent å¼€å‘è§„èŒƒã€‚

è¿™ä»½è§„èŒƒå®šä¹‰äº†ä¸€ä¸ª Agent åº”è¯¥å…·å¤‡çš„æ ‡å‡†ç”Ÿå‘½å‘¨æœŸã€å‡½æ•°ç»“æ„å’Œäº¤äº’æ–¹å¼ï¼Œç¡®ä¿æœªæ¥æ–°å¢ Agentï¼ˆå¦‚ Trader, Analyst ç­‰ï¼‰æ—¶èƒ½ä¿æŒæ¶æ„çš„ä¸€è‡´æ€§ã€‚

NewsieAI Agent å¼€å‘è§„èŒƒ (v1.0)
1. æ¶æ„åŸåˆ™
å¤§è„‘ (Brain): åŸºäº LangGraph çš„ create_agent (ReAct æ¨¡å¼)ã€‚

æ‰‹è„š (Tools): ä¸¥ç¦æœ¬åœ°ç¡¬ç¼–ç  Toolã€‚æ‰€æœ‰ Tool å¿…é¡»é€šè¿‡ MultiServerMCPClient è¿æ¥åˆ° start_mcp.py å®šä¹‰çš„å¾®æœåŠ¡ç«¯å£è·å–ã€‚

é€šä¿¡ (Protocol): å¼‚æ­¥ (asyncio)ï¼ŒåŸºäº LangChain Message åè®®ã€‚

2. æ ‡å‡† Agent ç±»ç»“æ„æ¨¡æ¿
æ¯ä¸ªæ–°çš„ Agent å¿…é¡»ä¸ºä¸€ä¸ª Python ç±»ï¼Œå¹¶åŒ…å«ä»¥ä¸‹ 6 ä¸ªæ ¸å¿ƒå‡½æ•°ã€‚

ğŸ“„ æ–‡ä»¶åå»ºè®®: [role]_agent.py (ä¾‹å¦‚: trader_agent.py)
Python

import asyncio
import json
import os
from typing import Any, Dict, Optional
from dotenv import load_dotenv

from langchain.agents import create_agent
from langchain_core.messages import HumanMessage
from langchain_mcp_adapters.client import MultiServerMCPClient
from langchain_openai import ChatOpenAI

load_dotenv()

class BaseStandardAgent:
    """
    [Agent Name]: ç®€çŸ­æè¿°è¯¥ Agent çš„èŒè´£ã€‚
    """

    def __init__(self, context_data: Any):
        """
        1. åˆå§‹åŒ–: è®¾ç½®ä¸Šä¸‹æ–‡æ•°æ®ã€LLM é…ç½®å’ŒçŠ¶æ€å˜é‡ã€‚
        """
        self.context_data = context_data
        
        # æ ‡å‡† LLM é…ç½®
        self.llm = ChatOpenAI(
            model=os.getenv("OPENAI_MODEL", "gpt-4o"),
            temperature=0 # æ¶‰åŠå†³ç­–å»ºè®®ç”¨ 0ï¼Œæ¶‰åŠåˆ›ä½œå»ºè®®ç”¨ 0.7
        )
        
        self.mcp_client = None
        self.agent_runnable = None # LangGraph ç¼–è¯‘åçš„å¯è¿è¡Œå®ä¾‹

    # ----------------------------------------------------------------
    # æ ¸å¿ƒå‡½æ•° 1: MCP è¿æ¥é…ç½® (å¿…é¡»å®ç°)
    # ----------------------------------------------------------------
    async def setup_mcp_client(self):
        """
        å®šä¹‰è¯¥ Agent éœ€è¦è¿æ¥å“ªäº› MCP æœåŠ¡ã€‚
        å‚è€ƒ start_mcp.py ä¸­çš„ç«¯å£é…ç½®ã€‚
        """
        # å¾…å¡«å……: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©è¿æ¥çš„æœåŠ¡
        # Pay: 8007, Search: 8001, Trade: 8002, Price: 8003
        mcp_config = {
            "target_service_name": {
                "url": f"http://localhost:{os.getenv('TARGET_PORT', '8000')}/mcp",
                "transport": "streamable-http"
            }
        }
        self.mcp_client = MultiServerMCPClient(mcp_config)

    # ----------------------------------------------------------------
    # æ ¸å¿ƒå‡½æ•° 2: è¾“å…¥æ•°æ®åŒ…è£¹å™¨ (å¿…é¡»å®ç°)
    # ----------------------------------------------------------------
    def _wrap_context_to_prompt(self) -> str:
        """
        å°†åŸå§‹è¾“å…¥æ•°æ® (self.context_data) è½¬æ¢ä¸º LLM å¯è¯»çš„ Prompt æ–‡æœ¬ã€‚
        åœ¨æ­¤å¤„è¿›è¡Œæ•°æ®æ¸…æ´—ã€æ ¼å¼åŒ–æˆ–æ·»åŠ ç³»ç»Ÿçº§å…ƒæ•°æ®ã€‚
        """
        # å¾…å¡«å……: è‡ªå®šä¹‰æ•°æ®æ ¼å¼åŒ–é€»è¾‘
        formatted_data = json.dumps(self.context_data, indent=2, ensure_ascii=False)
        return f"""
        TASK CONTEXT:
        {formatted_data}
        
        Please execute your assigned role based on this context.
        """

    # ----------------------------------------------------------------
    # æ ¸å¿ƒå‡½æ•° 3: æ ¸å¿ƒé€»è¾‘æ„å»º (å¿…é¡»å®ç°)
    # ----------------------------------------------------------------
    async def create_agent_graph(self):
        """
        æ„å»º LangGraph å›¾ï¼šè·å–å·¥å…· + å®šä¹‰ System Prompt + ç¼–è¯‘å›¾ã€‚
        """
        if not self.mcp_client:
            await self.setup_mcp_client()
        
        # 1. è·å–å·¥å…· (åŠ¨æ€ä» MCP æœåŠ¡ç«¯åŠ è½½)
        tools = await self.mcp_client.get_tools()
        
        # 2. å®šä¹‰å¤§è„‘ (System Prompt)
        # å¾…å¡«å……: è¯¦ç»†çš„ SOP (æ ‡å‡†ä½œä¸šç¨‹åº)
        system_prompt = """You are a [Role Name].
        
        Instructions:
        1. Analyze the input...
        2. Use tools to...
        3. Output format...
        """
        
        # 3. åˆ›å»ºå›¾
        self.agent_runnable = create_agent(self.llm, tools, system_prompt=system_prompt)

    # ----------------------------------------------------------------
    # æ ¸å¿ƒå‡½æ•° 4: è¿è¡Œå…¥å£ (æ ‡å‡†é€»è¾‘)
    # ----------------------------------------------------------------
    async def run(self) -> str:
        """
        æ‰§è¡Œ Agent ä¸»æµç¨‹ã€‚
        """
        if not self.agent_runnable:
            await self.create_agent_graph()
        
        # ä½¿ç”¨åŒ…è£¹å™¨å¤„ç†è¾“å…¥
        user_msg = self._wrap_context_to_prompt()
        
        # æ„é€  LangChain æ¶ˆæ¯
        inputs = {"messages": [HumanMessage(content=user_msg)]}
        
        # å¼‚æ­¥è°ƒç”¨å›¾
        result = await self.agent_runnable.ainvoke(inputs)
        
        # è¿”å›æœ€ç»ˆå›å¤
        return result["messages"][-1].content

    # ----------------------------------------------------------------
    # æ ¸å¿ƒå‡½æ•° 5: èµ„æºæ¸…ç† (æ ‡å‡†é€»è¾‘)
    # ----------------------------------------------------------------
    async def cleanup(self):
        """æ–­å¼€ MCP è¿æ¥ï¼Œé˜²æ­¢ç«¯å£å ç”¨æˆ–è¿æ¥æ³„æ¼ã€‚"""
        if self.mcp_client:
            try:
                await self.mcp_client.disconnect()
            except:
                pass

# ----------------------------------------------------------------
# æ ¸å¿ƒå‡½æ•° 6: å¤–éƒ¨ä¾¿æ·è°ƒç”¨å…¥å£ (Module Level Function)
# ----------------------------------------------------------------
async def run_agent_service(data: Any) -> str:
    """
    å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨æ­¤ Agent çš„ç»Ÿä¸€å…¥å£ã€‚
    è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ (Init -> Run -> Cleanup)ã€‚
    """
    agent = BaseStandardAgent(data)
    try:
        return await agent.run()
    finally:
        await agent.cleanup()

# ----------------------------------------------------------------
# æœ¬åœ°æµ‹è¯•æ¡© (Main)
# ----------------------------------------------------------------
if __name__ == "__main__":
    # å¾…å¡«å……: æ¨¡æ‹Ÿæµ‹è¯•æ•°æ®
    mock_data = {"test": "data"}
    print(asyncio.run(run_agent_service(mock_data)))